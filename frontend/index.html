<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom HMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-disconnected { background-color: #f87171; box-shadow: 0 0 8px #f87171; }
        .status-connected { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-error { background-color: #facc15; box-shadow: 0 0 8px #facc15; }
        .level-bar-bg { background-color: #374151; }
        .level-bar-fill { background-color: #3b82f6; transition: width 0.5s ease-in-out; }
        .tank-visualization {
            width: 64px;
            height: 96px;
            background-color: #1f2937;
            border: 2px solid #4b5563;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .tank-water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background-color: #0ea5e9;
            transition: height 0.5s ease-in-out;
        }
        .pipe {
            height: 8px;
            background-color: #6b7280;
        }
        .split-pipe {
            height: 95px;
            width: 8px;
            background-color: #6b7280;
        }
        .process-unit {
            border: 2px solid #4b5563;
            background-color: #374151;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 500;
        }
    </style>
</head>
<body class="h-full text-gray-200">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white">Custom HMI</h1>
            <p class="text-lg text-gray-400">Industrial Control System Dashboard</p>
            <div class="mt-4 flex justify-center space-x-4">
                <div class="flex items-center"><div class="status-dot status-connected mr-2"></div> Connected</div>
                <div class="flex items-center"><div class="status-dot status-disconnected mr-2"></div> Disconnected</div>
                <div class="flex items-center"><div class="status-dot status-error mr-2"></div> Error</div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="md:col-span-3 bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
                <h2 class="text-2xl font-semibold text-white mb-6">System Overview</h2>
                <div class="w-full overflow-x-auto pb-4">
                    <div class="flex items-center justify-between text-center text-xs min-w-[1000px]">

                        <div class="flex flex-col items-center w-20">
                            <svg id="pump-101" class="w-10 h-10 mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <span class="font-semibold">P-101</span>
                        </div>
                        <div class="flex-1 pipe"></div>
                        <div class="flex flex-col items-center">
                            <div class="tank-visualization mb-1">
                                <div id="tank-201-water" class="tank-water" style="height: 0%"></div>
                            </div>
                            <span class="font-semibold text-base">T-201</span>
                        </div>
                        <div class="flex-1 pipe"></div>
                        <div class="flex flex-col items-center w-20">
                            <svg id="valve-301" class="w-10 h-10 mb-1 text-gray-400" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 12h7v10h6V12h7L12 2z"/></svg>
                            <span class="font-semibold">MV-301</span>
                        </div>
                        <div class="flex-1 pipe"></div>

                        <div class="process-unit">Filtration</div>
                        <div class="flex-1 pipe"></div>
                        <div class="flex flex-col items-center">
                            <div class="tank-visualization mb-1">
                                <div id="tank-202-water" class="tank-water" style="height: 0%"></div>
                            </div>
                            <span class="font-semibold text-base">T-202</span>
                        </div>
                        <div class="flex-1 pipe"></div>
                        <div class="process-unit">Reverse Osmosis</div>
                        <div class="flex-1 pipe"></div>
                        <div class="split-pipe"></div>
                        <div class="flex flex-col items-center">
                            <div class="tank-visualization mb-1">
                                <div id="tank-203-water" class="tank-water" style="height: 0%"></div>
                            </div>
                            <span class="font-semibold text-base">T-203</span>
                            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                            <span class="font-semibold">CLEAN WATER</span>
                        </div>
                        <div class="flex-1 pipe"></div>
                        <div class="flex flex-col items-center w-20">
                            <svg id="pump-102" class="w-10 h-10 mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <span class="font-semibold">P-102</span>                            
                        </div>
                        <div class="flex-1 pipe"></div>
                        <div class="process-unit">Back To Filtration</div>
                    </div>
                </div>
            </div>
        </div>


        <div id="plc-cards-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>

<script>
    const plcCardsContainer = document.getElementById('plc-cards-container');
    const plcNames = ['PLC1 (T-201 Control)', 'PLC2 (T-202 Monitor)', 'PLC3 (T-203 Control)'];

    // Use current hostname for API requests
    const apiUrl = `http://${window.location.hostname}:3000/api/data`;

    const plcConfig = {
        'PLC1 (T-201 Control)': { max: 100, tankId: 'tank-201-water' },
        'PLC2 (T-202 Monitor)': { max: 30, tankId: 'tank-202-water' },
        'PLC3 (T-203 Control)': { max: 5, tankId: 'tank-203-water' }
    };

    // Initialize dashboard with empty cards
    function initializeDashboard() {
        plcCardsContainer.innerHTML = '';
        plcNames.forEach(name => {
            const safeName = name.replace(/\s+/g, '-');
            const isMonitor = name.includes('Monitor');
            
            const cardHtml = `
                <div id="card-${safeName}" class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-white">${name}</h2>
                        <div class="flex items-center gap-2">
                            <div id="status-dot-${safeName}" class="status-dot status-disconnected"></div>
                            <span id="status-text-${safeName}" class="text-sm font-medium text-gray-400">Inizializzazione...</span>
                        </div>
                    </div>
                    <div id="data-container-${safeName}" class="space-y-4">
                        <p class="text-center text-gray-500">In attesa di dati...</p>
                    </div>
                    ${isMonitor ? `
                    <div class="mt-4 p-3 bg-blue-900 bg-opacity-20 rounded-lg">
                        <p class="text-sm text-blue-300">This PLC monitors level and sends signals to PLC1 to control MV-301 valve</p>
                    </div>
                    ` : ''}
                </div>
            `;
            plcCardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        });
    }

    // Create a data row for display
    function createDataRow(label, value, isBoolean = false, trueLabel = "ON", falseLabel = "OFF") {
        let displayValue = value;
        if (isBoolean) {
            displayValue = value 
                ? `<span class="px-2 py-1 text-xs font-bold text-green-900 bg-green-400 rounded-full">${trueLabel}</span>`
                : `<span class="px-2 py-1 text-xs font-bold text-red-900 bg-red-400 rounded-full">${falseLabel}</span>`;
        }
        return `<div class="flex justify-between items-center text-lg"><span class="text-gray-400">${label}</span><span class="font-mono font-bold">${displayValue}</span></div>`;
    }

    // Update UI with new data
    function updateUI(data) {
        for (const plcName in data) {
            const plcState = data[plcName];
            const safeName = plcName.replace(/\s+/g, '-');
            const statusDot = document.getElementById(`status-dot-${safeName}`);
            const statusText = document.getElementById(`status-text-${safeName}`);
            const dataContainer = document.getElementById(`data-container-${safeName}`);

            statusDot.className = 'status-dot'; // Reset classes
            
            if (plcState.status === 'Connected') {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'Connesso';
                
                let content = '';
                const plcData = plcState.data;

                // Level Bar (common to all)
                const config = plcConfig[plcName] || { max: 100 };
                const levelValue = plcData.level || 0;
                const levelPercentage = (levelValue / config.max) * 100;
                
                // Update tank visualization
                if (config.tankId) {
                    const tankWater = document.getElementById(config.tankId);
                    if (tankWater) {
                        tankWater.style.height = `${levelPercentage}%`;
                    }
                }

                content += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-gray-400">Water Level</span>
                            <span class="text-sm font-medium text-white">${levelValue} / ${config.max}</span>
                        </div>
                        <div class="w-full level-bar-bg rounded-full h-4">
                            <div class="level-bar-fill h-4 rounded-full" style="width: ${levelPercentage}%"></div>
                        </div>
                    </div>
                `;

                // Specific data for each PLC
                if (plcName.includes('T-201')) {
                    content += createDataRow('Pump P-101', plcData.pump, true, 'RUNNING', 'STOPPED');
                    content += createDataRow('Valve MV-301', plcData.valve, true, 'OPEN', 'CLOSED');
                    content += createDataRow('Request Signal', plcData.request, true, 'ACTIVE', 'INACTIVE');
                    content += createDataRow('Underflow Alarm', plcData.underflow, true, 'ALARM', 'NORMAL');
                    content += createDataRow('Overflow Alarm', plcData.overflow, true, 'ALARM', 'NORMAL');
                } else if (plcName.includes('T-202')) {
                    content += createDataRow('Valve Request', plcData.request, true, 'REQUESTING', 'IDLE');
                    content += createDataRow('Low Level Signal', plcData.open_req, true, 'LOW', 'NORMAL');
                    content += createDataRow('High Level Signal', plcData.close_req, true, 'HIGH', 'NORMAL');
                } else if (plcName.includes('T-203')) {
                    content += createDataRow('Pump P-102', plcData.pump, true, 'RUNNING', 'STOPPED');
                    content += createDataRow('Low Level Alarm', plcData.low, true, 'ALARM', 'NORMAL');
                    content += createDataRow('High Level Alarm', plcData.high, true, 'ALARM', 'NORMAL');
                }
                
                dataContainer.innerHTML = content;

            } else if (plcState.status === 'Disconnected') {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'Disconnesso';
                dataContainer.innerHTML = '<p class="text-center text-gray-500">Connessione persa...</p>';
            } else {
                statusDot.classList.add('status-error');
                statusText.textContent = 'Errore';
                dataContainer.innerHTML = '<p class="text-center text-yellow-500">Errore durante la lettura dei dati.</p>';
            }
        }
    }

    // Main polling function
    async function fetchData() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            updateUI(data);
        } catch (error) {
            console.error("Fetch error:", error);
            // Handle fetch errors (e.g., backend unreachable)
            const errorState = {};
            plcNames.forEach(name => {
                errorState[name] = { status: 'Error', data: {} };
            });
            updateUI(errorState);
        }
    }

    // Initialize and start polling
    initializeDashboard();
    setInterval(fetchData, 1000); // Update every second
</script>
</body>
</html>